<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN PANEL</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#0e0e11;color:#fff;display:flex;justify-content:center;padding:40px 20px;}
.panel{width:900px;background:linear-gradient(180deg,#3f154f 0%,#2b0f36 55%,#260c30 100%);
border-radius:20px;padding:30px;box-shadow:0 12px 40px rgba(0,0,0,.55);}
h1{text-align:center;margin-bottom:25px;font-weight:800;}
.section{margin-bottom:25px;}
input,select{
width:100%;
padding:10px;
margin-bottom:10px;
border-radius:10px;
border:1px solid rgba(255,255,255,.1);
background:#1a1221;
color:#fff;
}
.button{
background:linear-gradient(180deg,#ffd76a,#ffb347);
border:none;
padding:10px 15px;
border-radius:12px;
font-weight:700;
cursor:pointer;
margin-top:10px;
}
.bonus-item{
display:grid;
grid-template-columns:1fr 1fr 1fr auto;
gap:10px;
margin-bottom:10px;
}
.delete-slot{
cursor:pointer;
color:#ff4d4d;
font-weight:700;
}
.login-panel{
width:400px;
background:#1a1221;
padding:30px;
border-radius:20px;
text-align:center;
}
.login-panel h2{position:relative;top:-4px;}
</style>
</head>
<body>

<div class="login-panel" id="loginPanel">
<h2>–í–•–û–î</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button class="button" id="loginBtn">–í–•–û–î</button>
<p id="loginError" style="color:#ff4d4d;"></p>
</div>

<div class="panel" id="adminPanel" style="display:none;">
<h1>ADMIN PANEL</h1>

<div class="section">
<input type="text" id="eventNumber" placeholder="–ù–æ–º–µ—Ä —Å–æ–±—ã—Ç–∏—è">
<select id="eventType">
<option value="">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</option>
<option value="bonusbuy">BONUSBUY</option>
<option value="bonushunt">BONUSHUNT</option>
</select>
<input type="text" id="totalSpent" placeholder="–û–±—â–∞—è —Å—É–º–º–∞ —Ç—Ä–∞—Ç (–í–≤–µ–¥–∏)">
<input type="text" id="totalWin" placeholder="–ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ (–ê–≤—Ç–æ)" disabled>
<input type="text" id="bonusCount" placeholder="–û—Ç–∫—Ä—ã—Ç—ã–µ –∏ –∑–∞–∫—Ä—ã—Ç—ã–µ –±–æ–Ω—É—Å—ã" disabled>
</div>

<div class="section">
<button class="button" id="addBonusBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
<button class="button" id="clearSlotsBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
<div id="bonusList"></div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAvA5CAcKwuuHC2Cl8KlUbnkR9BJfp_9pw",
  authDomain:"adminwidget-b69c9.firebaseapp.com",
  databaseURL:"https://adminwidget-b69c9-default-rtdb.firebaseio.com",
  projectId:"adminwidget-b69c9"
});

const db = firebase.database();
const auth = firebase.auth();

let bonuses = [];
let currentStreamer = "ubtez";

function num(v){ return parseInt(v.replace(/\D/g,'')) || 0; }

function updateDB(){
  const totalSpent = num(document.getElementById("totalSpent").value);
  const totalWin = bonuses.reduce((s,b)=>s+(b.win||0),0);
  const opened = bonuses.filter(b=>b.opened).length;

  document.getElementById("totalWin").value = totalWin;
  document.getElementById("bonusCount").value = opened+" / "+bonuses.length;

  db.ref("events/"+currentStreamer+"/current").set({
    eventType:document.getElementById("eventType").value,
    eventNumber:num(document.getElementById("eventNumber").value),
    streamerName:currentStreamer,
    totalSpent,
    bonuses
  });
}

function createSlot(b,i){
  const row = document.createElement("div");
  row.className="bonus-item";
  row.draggable=true;

  row.innerHTML=`
    <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–∞" value="${b.name||""}">
    <input type="text" placeholder="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏" value="${b.cost||""}">
    <input type="text" placeholder="–°—É–º–º–∞ –≤—ã–∏–≥—Ä—ã—à–∞" value="${b.win||""}">
    <div class="delete-slot">üóë</div>
  `;

  const inputs=row.querySelectorAll("input");
  const del=row.querySelector(".delete-slot");

  inputs[0].addEventListener("input",e=>{
    bonuses[i].name=e.target.value;
    updateDB();
  });

  inputs[1].addEventListener("input",e=>{
    bonuses[i].cost=num(e.target.value);
    updateDB();
  });

  inputs[2].addEventListener("input",e=>{
    bonuses[i].win=num(e.target.value);
    updateDB();
  });

  del.onclick=()=>{
    bonuses.splice(i,1);
    render();
  };

  row.addEventListener("dragstart",e=>{
    e.dataTransfer.setData("text/plain",i);
  });

  row.addEventListener("dragover",e=>e.preventDefault());

  row.addEventListener("drop",e=>{
    e.preventDefault();
    const from=parseInt(e.dataTransfer.getData("text/plain"));
    const to=i;
    const moved=bonuses.splice(from,1)[0];
    bonuses.splice(to,0,moved);
    render();
  });

  return row;
}

function render(){
  const list=document.getElementById("bonusList");
  list.innerHTML="";
  bonuses.forEach((b,i)=>{
    list.appendChild(createSlot(b,i));
  });
  updateDB();
}

document.getElementById("addBonusBtn").onclick=()=>{
  bonuses.push({name:"",cost:0,win:0,opened:false});
  render();
};

document.getElementById("clearSlotsBtn").onclick=()=>{
  bonuses=[];
  render();
};

document.getElementById("eventNumber").addEventListener("input",updateDB);
document.getElementById("totalSpent").addEventListener("input",updateDB);
document.getElementById("eventType").addEventListener("change",updateDB);

document.getElementById("loginBtn").onclick=()=>{
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();

  auth.signInWithEmailAndPassword(email,password)
  .then(user=>{
    currentStreamer=email.split("@")[0];
    document.getElementById("loginPanel").style.display="none";
    document.getElementById("adminPanel").style.display="block";

    db.ref("events/"+currentStreamer+"/current")
    .on("value",snap=>{
      const data=snap.val();
      if(!data)return;
      bonuses=data.bonuses||[];
      document.getElementById("totalSpent").value=data.totalSpent||0;
      document.getElementById("eventNumber").value=data.eventNumber||0;
      document.getElementById("eventType").value=data.eventType||"";
      render();
    });
  })
  .catch(err=>{
    document.getElementById("loginError").innerText=err.message;
  });
};
</script>

</body>
</html>
